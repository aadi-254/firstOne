<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #202020;
        }

        /******************* sidebar *******************/


        .sidebar {
            position: fixed;
            top: 0%;
            left: 0%;
            width: 250px;
            height: 100%;
            background: #2B2D31;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .menu {
            list-style: none;
            padding: 0;
            width: 100%;
            margin-top: 40%;
        }

        .menu li {
            width: 100%;
        }

        .menu a {
            text-decoration: none;
            color: #ffffff;
            display: grid;
            grid-template-columns: 1fr 2fr;
            padding: 15px 50px;
            transition: background 0.3s ease;
        }

        .menu a i {
            /* color: #de71ff; */
            font-size: 20px;
        }

        .menu a:hover {
            background: #333;
        }



        .toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #000000;
            color: #fff;
            border: none;
            font-size: 20px;
            padding: 10px;
            cursor: pointer;
            z-index: 1100;
            border-radius: 5px;
            display: none;
        }

        /******** main content ***************/

        .main-content {
            border-radius: 10px;
            margin-top: 1%;
            margin-left: 260px;
            padding: 20px;
            flex: 1;
            background: #1E1F22;
            color: #e0e0e0;
        }

        .main-content h1 {
            margin-bottom: 20px;
        }

        /********************** posts *********************/

        .postBox {
            height: auto;
            width: 50%;
            max-width: 1000px;
            margin-left: 20%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .postHead {
            font-family: 'Poppins';
            margin-left: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .postHead .profilePhoto {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .profilePhoto img {
            height: 100%;
            width: 100%;
        }

        .postHead a {
            text-decoration: none;
            color: black;
            font-weight: 200;
            font-size: 20px;
        }

        .postHead span {
            font-size: 13px;
        }

        .postData {
            font-family: 'Poppins';
            border-radius: 10px;
            padding: 15px;
            /* background: #252525; */
            background: transparent;
            color: #b0b0b0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: justify;
            line-height: 25px;
            gap: 5%;
        }

        .Describe {
            width: 90%;

        }

        .image {
            width: 70%;
            height: calc(85% + 2vh);
            min-width: 200px;
            min-height: 200px;
            max-height: 260px;
            overflow: hidden;
        }

        .like-btn {
            border: none;
            height: 20px;
            width: 30px;
            font-size: 20px;
            color: #bdbdbd;
        }

        .read-more {
            background-color: transparent;
            border: none;
            color: #c7e3ff;
            cursor: pointer;
            font-size: 14px;
        }

        .more-text {
            display: none;
        }

        /******** comment **************/


        .comment {
            position: fixed;
            top: 10%;
            display: none;
            transform: translateX(-100vw);
            width: 90vw;
            max-width: 700px;
            max-height:200px ;
            overflow-y: scroll;
            margin: 15px auto;
            background: #1e1e1e;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .comment-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 4px;
            margin-bottom: 4px;
        }

        .comment-username {
            font-size: 16px;
            font-weight: bold;
            color: #f0f0f0;
        }

        .comment-text {
            font-size: 16px;
            color: #d3d3d3;
            background: #292929;
            border-radius: 6px;
            padding: 8px;
            word-wrap: break-word;
        }


        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }

            .sidebar.hidden {
                transform: translateX(-100vw);
            }

            .sidebar {
                width: 80vw;
            }

            .toggle-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                background: #000000;
                color: #fff;
                border: none;
                font-size: 20px;
                padding: 10px;
                cursor: pointer;
                z-index: 1100;
                border-radius: 5px;
            }

            .main-content.collapsed {
                margin-left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .postBox {
                width: 98%;
                margin-left: 2%;
            }

            .Describe {
                width: 100%;
            }

            .sidebar.active {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {

            .toggle-btn {
                display: block;
            }

            .sidebar {
                width: 80vw;
            }

            .postData {
                flex-direction: column;
            }

            .image {
                width: 85%;
            }
        }

        @media (max-width: 480px) {}
    </style>
</head>

<body>
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

    <div class="sidebar hidden" id="sidebar">
        <p style="font-size:30px;font-weight: 100;margin-top: 40px;">RateMyThoughts</p>
        <ul class="menu">
            <li><a href="/dashboard"><i class="fa-solid fa-house"></i>Home</a></li>
            <li><a href="/profile"><i class="fa-solid fa-user"></i>Profile</a></li>
            <li><a href="/createpost"><i class="fa-regular fa-square-plus"></i>Create a post</a></li>
            <li><a href="/updateProfile"><i class="fa-solid fa-pen-to-square"></i>Update your profile</a></li>
        </ul>
        <a href="/logout"
            style="text-decoration: none;text-align: center;margin-top: 20px;width: 100px;color: white;background: red;padding: 10px;">Log
            out</a>
    </div>

    <div class="main-content collapsed" id="main-content">

        <div style="width: 100%; display: flex;align-items: center;justify-content: center;">
            <h1> Posts </h1>
        </div>

        <!-- Posts (Thoughts) Section -->
        <div class="postsDashboard" id="postsDashboard">
            <% data.forEach(post=> { %>
                <div class="postBox" data-post-id="<%= post.thought_id %>">

                    <div class="postHead">
                        <div class="profilePhoto">
                            <img src="<%= post.profilePhoto %>" alt="">
                        </div>
                        <a href="/search/<%= post.p_username %>" style="color: white;">
                            <%= post.p_username %>
                        </a>
                    </div>

                    <div class="postData">
                        <div class="Describe" style="font-size: calc(13px + 0.3vw);">
                            <p class="content">
                                <%= post.content.substring(0, 200) %>
                                    <span class="more-text" style="display: none;">
                                        <%= post.content.substring(200) %>
                                    </span>
                            </p>
                            <% if (post.content.length> 200) { %>
                                <button class="read-more">Read More</button>
                                <% } %>
                        </div>
                        <% if (post.image_url) { %>
                            <div class="image">
                                <img src="<%= post.image_url %>" style="width: 100%; height: 100%; max-height: 300px;"
                                    alt="Post image">
                            </div>
                            <% } %>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="display: flex; font-size: 20px; color: white; gap: 40px;">
                            <div style="display: flex; gap: 8px;">
                                <i class="fa-solid fa-up-long vote-btn" data-vote="upvote"
                                    style="color: rgb(8, 255, 8);"></i>
                                <span class="upvote-count">
                                    <%= post.upvotes %>
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <i class="fa-solid fa-down-long vote-btn" data-vote="downvote"
                                    style="color: rgb(255, 60, 0);"></i>
                                <span class="downvote-count">
                                    <%= post.downvotes %>
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;" class="comments"
                                data-thought-id="<%= post.thought_id %>">
                                <i class="fa-solid fa-comment" style="color: rgb(63, 191, 255);"></i>
                                <span class="comments-count">
                                    <%= post.comments.length %>
                                </span>
                            </div>
                        </div>
                        <span style="margin-left: 30%;font-size: 13px;">
                            <%= new Date(post.created_at).toLocaleString() %>
                        </span>
                    </div>
                </div>

                <div class="comment comment-<%= post.thought_id %>" style="display: none;">
                    <h1>Comments</h1>
                    <i class="fa-solid fa-xmark close-comment"
                        style="position: absolute; right: 10px; top: 20px; font-size: 20px;"></i>
                    <div class="comment-container">
                        <% if (post.comments && post.comments.length> 0) { %>
                            <% post.comments.forEach(comment=> { %>
                                <% if (comment.comment_t_id==post.thought_id) { %>
                                    <div class="comment-box">
                                        <span class="comment-username">
                                            <%= comment.username %>
                                        </span>:
                                        <%= comment.text %>
                                    </div>
                                    <% } %>
                                        <% }); %>
                                            <% } else { %>
                                                <p>No comments yet.</p>
                                                <% } %>
                    </div>
                    <form class="comment-form" method="post" style="display: flex; gap: 20px; margin-top: 20px;">
                        <input type="hidden" name="thought_id" value="<%= post.thought_id %>">
                        <input type="hidden" name="username" id="username" value="<%= post.p_username %>">
                        <input type="text" name="comment_text" placeholder="Enter your comment." required
                            style="margin-left: 10px; width: 70%; padding: 8px;">
                        <button type="submit"
                            style="background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; width: 40px; height: 40px; color: white;">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
                <br><br>
                <hr style="width: 100%; opacity: 0.2; height: 1px;"><br>
                <% }); %>
        </div>



    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    
    <script>

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const isHidden = sidebar.classList.contains('hidden');

            if (isHidden) {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('collapsed');
            } else {
                sidebar.classList.add('hidden');
                mainContent.classList.add('collapsed');
            }
        }
    </script>

<script>

/*********************** voting ***********************/

        $(document).ready(function () {
            $(".vote-btn").click(function () {
                let postBox = $(this).closest(".postBox");
                let thoughtId = postBox.data("post-id");
                // console.log(thoughtId)
                let voteType = $(this).data("vote");
                let voteCountElement = $(this).next(); // Select next span (vote count)

                $.ajax({
                    url: "/vote",
                    type: "POST",
                    data: { thought_id: thoughtId, vote_type: voteType },
                    success: function (response) {
                        if (response.success) {
                            voteCountElement.text(response.new_count);
                        } else {
                            alert(response.message);
                        }
                    }
                });
            });


        });
    </script>

    <script>

        

        /*************************** [ comment script ] ************************/
        let offset = 7;
        document.addEventListener('DOMContentLoaded', () => {

            let loading = false; // Prevents multiple submissions

function attachCommentEventListeners() {
    // Remove existing event listeners before adding new ones
    document.querySelectorAll('.comment-form').forEach(form => {
        form.replaceWith(form.cloneNode(true)); // Removes old event listeners
    });

    document.querySelectorAll('.comments').forEach(icon => {
        icon.onclick = async (event) => {
            const thoughtId = icon.closest('.postBox').dataset.postId;
            const commentSection = document.querySelector(`.comment-${thoughtId}`);
            commentSection.style.display = 'block';
            commentSection.style.transform = 'translateX(0vw)';
        };
    });

    document.querySelectorAll('.close-comment').forEach(closeButton => {
        closeButton.onclick = (event) => {
            const commentSection = event.target.closest('.comment');
            commentSection.style.display = 'none';
            commentSection.style.transform = 'translateX(-100vw)';
        };
    });

    document.querySelectorAll('.comment-form').forEach(commentForm => {
        commentForm.onsubmit = async (event) => {
            event.preventDefault();

            if (loading) return; // Prevent multiple clicks
            loading = true;

            const thoughtId = commentForm.querySelector('input[name="thought_id"]').value;
            const commentText = commentForm.querySelector('input[name="comment_text"]').value.trim();
            const commentContainer = commentForm.closest('.comment').querySelector('.comment-container');
            const username = document.getElementById("username").value;

            if (!commentText) {
                loading = false;
                return;
            }

            try {
                const response = await fetch('/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ thought_id: thoughtId, comment_text: commentText })
                });

                const data = await response.json();
                if (data.success) {
                    const commentBox = document.createElement('div');
                    commentBox.classList.add('comment-box');
                    commentBox.innerHTML = `<span class="comment-username">${username}</span>: ${commentText}`;
                    commentContainer.prepend(commentBox);
                    commentForm.querySelector('input[name="comment_text"]').value = '';

                    const commentCountSpan = document.querySelector(`.comments[data-thought-id="${thoughtId}"] .comments-count`);
                    if (commentCountSpan) {
                        commentCountSpan.textContent = parseInt(commentCountSpan.textContent) + 1;
                    }
                }
            } catch (error) {
                console.error('Error posting comment:', error);
            }

            loading = false; // Reset loading state after request completes
        };
    });
}

attachCommentEventListeners(); // Attach initially
 // Attach initially

/*********************** post loader ************************************/

window.addEventListener("scroll", function() {
        // Option 1: Load when 50vh above the bottom (more user-friendly)
        const triggerPoint = document.body.scrollHeight - window.innerHeight - (window.innerHeight * 0.5); // 50vh from bottom
        const userPosition = window.scrollY;

if (userPosition >= triggerPoint && !loading) {
        
            loading = true;

                fetch(`/loadMorePosts?offset=${offset}`)
                    .then(response => response.json()) // ✅ Expect JSON
                    .then(data => {
                        if (data.success) {
                            data.posts.forEach(post => {
                                document.getElementById('postsDashboard').innerHTML += `
                        <div class="postBox" data-post-id="${post.thought_id}">
                        <div class="postHead">
                            <div class="profilePhoto">
                                <img src="${post.profilePhoto}" alt="">
                            </div>
                            <a href="/search/${post.p_username}" style="color: white;">${post.p_username}</a>
                        </div>

                        <div class="postData">
                            <div class="Describe" style="font-size: calc(13px + 0.3vw);">
                                <p class="content">
                      ${post.content.length > 200 
                        ? post.content.substring(0, 200)+'...' + '<span class="more-text" style="display: none;">' + post.content.substring(200) + '</span>' 
                        : post.content}
                    </p>

                                ${post.content.length > 200 ? '<button class="read-more">Read More</button>' : ''}
                            </div>
                            ${post.image_url ? `<div class="image"><img src="${post.image_url}" style="width: 100%; max-height: 300px;"></div>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="display: flex; font-size: 20px; color: white; gap: 40px;">
                                <div style="display: flex; gap: 8px;">
                                    <i class="fa-solid fa-up-long vote-btn" data-vote="upvote" style="color: rgb(8, 255, 8);"></i>
                                    <span class="upvote-count">${post.upvotes}</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <i class="fa-solid fa-down-long vote-btn" data-vote="downvote" style="color: rgb(255, 60, 0);"></i>
                                    <span class="downvote-count">${post.downvotes}</span>
                                </div>
                                <div style="display: flex; gap: 8px;" class="comments" data-thought-id="${post.thought_id}">
                                    <i class="fa-solid fa-comment" style="color: rgb(63, 191, 255);"></i>
                                    <span class="comments-count">${post.comments.length}</span>
                                </div>
                            </div>
                            <span style="margin-left: 30%;">
                                ${new Date(post.created_at).toLocaleString()}
                            </span>
                        </div>
                    </div>

                    <div class="comment comment-${post.thought_id}">
        <h1>Comments</h1>
        <i class="fa-solid fa-xmark close-comment" style="position: absolute; right: 10px; top: 20px; font-size: 20px;"></i>
        <div class="comment-container">
            ${post.comments && post.comments.length > 0 ?
                                        post.comments
                                            .filter(comment => comment.comment_t_id === post.thought_id)
                                            .map(comment => `
                        <div class="comment-box">
                            <span class="comment-username">${comment.username}</span>: ${comment.text}
                        </div>
                    `).join('')
                                        : '<p>No comments yet.</p>'
                                    }
        </div>
        <form class="comment-form" method="post" style="display: flex; gap: 20px; margin-top: 20px;">
            <input type="hidden" name="thought_id" value="${post.thought_id}">
            <input type="hidden" name="username" id="username" value="${post.p_username}">
            <input type="text" name="comment_text" placeholder="Enter your comment." required style="margin-left: 10px; width: 70%; padding: 8px;">
            <button type="submit" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; width: 40px; height: 40px; color: white;">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </form>
    </div>
    <br><br><hr style="width: 100%; opacity: 0.2; height: 1px;"><br>
                    `;
                            });
                            offset += 7;
                            loading = false;
                            attachCommentEventListeners();
                            attachReadMoreEventListeners();
                        }
                    })
                    .catch(error => console.error('Error loading posts:', error));
            }
        })
        function attachReadMoreEventListeners() {
  document.querySelectorAll(".read-more").forEach(button => {
    button.addEventListener("click", function () {
      const content = this.previousElementSibling.querySelector(".more-text");

      if (content.style.display === "none") {
        content.style.display = "inline";
        this.textContent = "Read Less";
      } else {
        content.style.display = "none";
        this.textContent = "Read More";
      }
    });
  });
}

        });

        
    </script>




</body>

</html>
